#include <Arduino.h>
#include <AccelStepper.h>

// Define stepper motor (Driver mode: step pin 7, direction pin 6)
AccelStepper stepper(1, 7, 6);

// Pin definitions
const int JOYSTICK_PIN = 8;    // Joystick button (KEY D8)
const int POT_PIN = A0;         // Potentiometer for speed control

// Variables
int currentDirection = 1;       // 1 = forward, -1 = reverse
bool lastButtonState = HIGH;    // Joystick button is active LOW
bool buttonState = HIGH;
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 50;  // 50ms debounce

void setup() {
  // Initialize serial for debugging (optional)
  Serial.begin(9600);
  
  // Configure joystick button pin
  pinMode(JOYSTICK_PIN, INPUT_PULLUP);  // Use internal pull-up resistor
  
  // Configure stepper motor
  stepper.setMaxSpeed(1000);      // Maximum speed in steps/sec
  stepper.setAcceleration(500);   // Acceleration in steps/secÂ²
  stepper.setSpeed(200);          // Initial speed
  
  Serial.println("Stepper Motor Control Ready");
  Serial.println("Press joystick button to reverse direction");
  Serial.println("Use potentiometer to control speed");
}

void loop() {
  // Read potentiometer and map to speed (50 to 1000 steps/sec)
  int potValue = analogRead(POT_PIN);
  float speed = map(potValue, 0, 1023, 50, 1000);
  
  // Read joystick button with debouncing
  bool reading = digitalRead(JOYSTICK_PIN);
  
  // Check if button state changed
  if (reading != lastButtonState) {
    lastDebounceTime = millis();  // Reset debounce timer
  }
  
  // If button state has been stable for debounce delay
  if ((millis() - lastDebounceTime) > debounceDelay) {
    // If button state has actually changed
    if (reading != buttonState) {
      buttonState = reading;
      
      // Button pressed (LOW because of pull-up)
      if (buttonState == LOW) {
        // Reverse direction
        currentDirection *= -1;
        
        Serial.print("Direction changed to: ");
        Serial.println(currentDirection == 1 ? "Forward" : "Reverse");
      }
    }
  }
  
  lastButtonState = reading;
  
  // Set motor speed with current direction
  stepper.setSpeed(speed * currentDirection);
  
  // Run the motor at constant speed
  stepper.runSpeed();
  
  // Optional: Print speed every second for debugging
  static unsigned long lastPrint = 0;
  if (millis() - lastPrint > 1000) {
    Serial.print("Speed: ");
    Serial.print(abs(speed));
    Serial.print(" steps/sec, Direction: ");
    Serial.println(currentDirection == 1 ? "Forward" : "Reverse");
    lastPrint = millis();
  }
}